<?xml version="1.0" encoding="utf-8"?>
<s:Application xmlns:fx="http://ns.adobe.com/mxml/2009" 
			   xmlns:s="library://ns.adobe.com/flex/spark" 
			   xmlns:mx="library://ns.adobe.com/flex/mx" width="100%" height="100%"
			   creationComplete="PageLoad()" xmlns:WrbComp="WrbComp.*" xmlns:WrbHelpComp="WrbHelpComp.*"
			   pageTitle="Booking Status Report">
	<fx:Script>
		<![CDATA[
			import com.as3xls.xls.ExcelFile;
			import com.as3xls.xls.Sheet;
			
			import mx.events.CalendarLayoutChangeEvent;
			import mx.events.FlexEvent;
			public static var Global_AC:ArrayCollection = new ArrayCollection();
			public static var GlobalXml:String = "";
			public var ClientId:int=0,RangeEnd:String="";
			
			protected function PageLoad():void
			{
				Global_AC=funLoginInfo("<FlexServiceUrl>http://192.168.1.135/WebService/clsDataInterface.asmx?WSDL</FlexServiceUrl><FlexSwfUrl>http://192.168.1.135/wrperp/</FlexSwfUrl><gVchTypCd>PO</gVchTypCd><gVchTypDesc>Purchase Order</gVchTypDesc><gVchTypFk>387</gVchTypFk><gLocFk>1</gLocFk><gUmpFk></gUmpFk><gFyrFk>2</gFyrFk><gUsr>ADMIN</gUsr><gUsrFk>4</gUsrFk><gCur>Indian Rupees</gCur><gCurFk>1</gCurFk><gCurRt> 1.0000000</gCurRt><gPrintPath></gPrintPath><gScrId>551</gScrId><gCPRights>10101111</gCPRights>")
				GlobalXml="";
				GlobalXml += "<ROOT>";
				GlobalXml += ObjToXmlStr_Comm(Global_AC,"GlobalXml")
				GlobalXml += "</ROOT>";				
				FnHelp_PageLoad();
			}
			
			protected function FnHelp_PageLoad():void
			{
				useWeb("ApartmentBooking","PageLoad_CUSTOM",[GlobalXml,'BookingDtls','','','','',0,0,0,0,0,0,0]);				
			}
			
			private function Custom_WebSer_Result (Ds_Objects:Object):void				
			{
				if (Ds_Objects.currentTarget.description.toString() == "PageLoad_CUSTOM")
				{
					Grd_BookingDtls.dataProvider=null;Dt_FromDt.text="";Dt_ToDt.text="";
					var asd:ArrayCollection=new ArrayCollection();RangeEnd="";
					Hlp_ClientName.dataProvider=asd;Hlp_ClientName.fnClear();ClientId=0;
					if (Ds_Objects.result.Tables.Table.Rows.length > 0)
					{
						Dt_FromDt.text = Ds_Objects.result.Tables.Table.Rows[0].FrmDt;
						Dt_ToDt.text = Ds_Objects.result.Tables.Table.Rows[0].FrmDt;
						//
						var Dt:String = Ds_Objects.result.Tables.Table.Rows[0].Dt;										
						var Y:String = Dt.substr(6,10);
						var M:String = Dt.substr(3,2);
						var D:String = Dt.substr(0,2);
						//var D:String =String(Number(Dt.substr(0,2))+1);
						RangeEnd = Y+'/'+M+'/'+D;						
						Dt_ToDt.selectableRange = {rangeEnd:new Date(RangeEnd)};
						//Dt_ToDt.selectedDate = new Date(RangeEnd);
						//
						//var D1:String =String(Number(Dt.substr(0,2)));
						//var RangeStart1:String = Y+'/'+M+'/'+D1;
						Dt_FromDt.selectableRange = {rangeEnd:new Date(RangeEnd)};
					}
					if (Ds_Objects.result.Tables.Table1.Rows.length > 0)
					{
						Hlp_ClientName.dataProvider=Ds_Objects.result.Tables.Table1.Rows as ArrayCollection;
					}
					if (Ds_Objects.result.Tables.Table2.Rows.length > 0)
					{
						Grd_BookingDtls.dataProvider=Ds_Objects.result.Tables.Table2.Rows as ArrayCollection;
					}					
				}
				if (Ds_Objects.currentTarget.description.toString() == "BookingDtls_CUSTOM")
				{
					Grd_BookingDtls.dataProvider=null;
					if (Ds_Objects.result.Tables.Table.Rows.length > 0)
					{
						Grd_BookingDtls.dataProvider=Ds_Objects.result.Tables.Table.Rows as ArrayCollection;
					}
				}
			}
			
			protected function Btn_Show_clickHandler(event:MouseEvent):void
			{
				Btn_Show.setFocus();
				useWeb("ApartmentBooking","BookingDtls_CUSTOM",[GlobalXml,'BookingDtls',
					Dt_FromDt.text,Dt_ToDt.text,'','',0,0,ClientId,0,0,0,0]);
			}			

			protected function Btn_ExporttoExcel_clickHandler(event:MouseEvent):void
			{
				if(Grd_BookingDtls.dataProvider != null)
				{
					var arrExportResult:ArrayCollection = Grd_BookingDtls.dataProvider as ArrayCollection;
					var xlsFile:ExcelFile = new ExcelFile();
					var sheet:Sheet = new Sheet();					
					sheet.resize(arrExportResult.length+1,17);					
					sheet.setCell(0,0,'SNo');
					sheet.setCell(0,1,'BookingCode');
					sheet.setCell(0,2,'MasterClientName');
					sheet.setCell(0,3,'ClientName');
					sheet.setCell(0,4,'CRMName');
					sheet.setCell(0,5,'PropertyName');
					sheet.setCell(0,6,'GuestName');
					sheet.setCell(0,7,'CheckInDt');
					sheet.setCell(0,8,'CheckOutDt');
					sheet.setCell(0,9,'StayDays');
					sheet.setCell(0,10,'Tariff / Day');
					sheet.setCell(0,11,'Total Tariff');
					sheet.setCell(0,12,'Booking Level');
					sheet.setCell(0,13,'Tariff Payment Mode');					
					sheet.setCell(0,14,'Status');
					sheet.setCell(0,15,'UserName');
					sheet.setCell(0,16,'BookingDate');					
					for(var i:int = 0; i < arrExportResult.length; i++)
					{
						sheet.setCell(i+1, 0, arrExportResult[i].SNo);
						sheet.setCell(i+1, 1, arrExportResult[i].BookingCode);
						sheet.setCell(i+1, 2, arrExportResult[i].MasterClientName);						
						sheet.setCell(i+1, 3, arrExportResult[i].ClientName);
						sheet.setCell(i+1, 4, arrExportResult[i].CRMName);
						sheet.setCell(i+1, 5, arrExportResult[i].PropertyName);
						sheet.setCell(i+1, 6, arrExportResult[i].GuestName);
						sheet.setCell(i+1, 7, arrExportResult[i].CheckInDt);
						sheet.setCell(i+1, 8, arrExportResult[i].CheckOutDt);
						sheet.setCell(i+1, 9, arrExportResult[i].StayDays);
						sheet.setCell(i+1, 10, arrExportResult[i].Tariff);
						sheet.setCell(i+1, 11, arrExportResult[i].TotalTariff);
						sheet.setCell(i+1, 12, arrExportResult[i].BookingLevel);
						sheet.setCell(i+1, 13, arrExportResult[i].TariffPaymentMode);
						sheet.setCell(i+1, 14, arrExportResult[i].Status);
						sheet.setCell(i+1, 15, arrExportResult[i].UserName);
						sheet.setCell(i+1, 16, arrExportResult[i].BookingDate);
					}
					xlsFile.sheets.addItem(sheet);      
					var bytes:ByteArray = xlsFile.saveToByteArray();
					var fr:FileReference = new FileReference();
					var FromDt:String = Dt_FromDt.text;					
					var ToDt:String = Dt_ToDt.text;
					var T1:String = FromDt.substr(0,2)+'-'+FromDt.substr(3,2)+'-'+FromDt.substr(6,10);
					var T2:String = ToDt.substr(0,2)+'-'+ToDt.substr(3,2)+'-'+ToDt.substr(6,10);
					var T:String="";
					if (T1 != T2)
					{
						T = "Booking Status Report "+T1+" to "+T2+".xls";
					}
					else
					{
						T = "BookingStatusReport "+T1+".xls";
					}
					fr.save(bytes,T);
				}
				else
				{
					alignAlert(Alert.show("Guest Details is Required.","Alert Message !",
						Alert.OK,null,null,iconWarning,Alert.OK),10,"");
				}				
			}
			
			protected function Dt_FromDt_changeHandler(event:CalendarLayoutChangeEvent):void
			{
				if(Dt_FromDt.selectedDate)
				{
					var Dt:String = Dt_FromDt.text;					
					var Y:String = Dt.substr(6,10);
					var M:String = Dt.substr(3,2);
					var D:String = Dt.substr(0,2);
					var RangeStart:String = Y+'/'+M+'/'+D;
					var sda:String=Dt_ToDt.text;
					var Y1:String = sda.substr(6,10);
					var M1:String = sda.substr(3,2);
					var D1:String = sda.substr(0,2);
					//var D:String =String(Number(Dt.substr(0,2))+1);
					var ToDt:String = Y1+'/'+M1+'/'+D1;
					Dt_ToDt.selectableRange = {rangeStart:new Date(RangeStart),rangeEnd:new Date(RangeEnd)};
					if(new Date(RangeStart) > new Date(ToDt))
					{
						Dt_ToDt.selectedDate = new Date(RangeStart);
					}
					else
					{
						Dt_ToDt.selectedDate = new Date(ToDt);
					}				
				}
			}
			
			public function FnOnselection_Client():void
			{
				if(Hlp_ClientName.selected())
				{
					Hlp_ClientName.text=Hlp_ClientName.Select_Row.ClientName;
					ClientId=Hlp_ClientName.Select_Row.Id;
				}
				else
				{
					Hlp_ClientName.fnClear();ClientId=0;					
				}
				Dt_FromDt.setFocus();
			}
			
		]]>
	</fx:Script>
	<fx:Declarations>
		<!-- Place non-visual elements (e.g., services, value objects) here -->
	</fx:Declarations>
	<fx:Script source = "..\\Common\\CommonScript.as"/>
	<fx:Script source = "..\\Common\\Functions.as"/>
	<fx:Style source="..\\Common\\ApplicationCSS.css"/>
	<s:VGroup x="0" y="0" width="100%" height="100%" horizontalAlign="center" verticalAlign="middle">
		<s:BorderContainer width="100%" height="100%" backgroundColor="#fbf9f9" borderVisible="false">
			<mx:DataGrid id="Grd_BookingDtls" x="0" y="55" width="100%" height="100%"
						 horizontalScrollPolicy="off">
				<mx:columns>
					<mx:DataGridColumn width="50" dataField="SNo"/>
					<mx:DataGridColumn dataField="BookingCode"/>					
					<mx:DataGridColumn dataField="MasterClientName"/>
					<mx:DataGridColumn dataField="ClientName"/>
					<mx:DataGridColumn dataField="CRMName"/>
					<mx:DataGridColumn dataField="PropertyName"/>
					<mx:DataGridColumn dataField="GuestName"/>
					<mx:DataGridColumn dataField="CheckInDt"/>
					<mx:DataGridColumn dataField="CheckOutDt"/>
					<mx:DataGridColumn dataField="StayDays"/>					
					<mx:DataGridColumn dataField="Tariff"/>
					<mx:DataGridColumn dataField="TotalTariff"/>
					<mx:DataGridColumn dataField="BookingLevel"/>
					<mx:DataGridColumn dataField="TariffPaymentMode"/>					
					<mx:DataGridColumn dataField="Status"/>
					<mx:DataGridColumn dataField="UserName"/>
					<mx:DataGridColumn dataField="BookingDate"/>					
				</mx:columns>
			</mx:DataGrid>			
			<WrbHelpComp:HelpText id="Hlp_ClientName" x="66" y="17.5" width="200" height="23"
								  onselection="{FnOnselection_Client()}" pxSetColumnsWidth="198,0"/>
			<mx:Label x="10" y="18.5" text="Client"/>
			<s:HGroup x="274" y="13" width="640" height="32" horizontalAlign="center" 
					  verticalAlign="middle" gap="20">
				<mx:Label text="From Date"/>
				<mx:DateField id="Dt_FromDt" change="Dt_FromDt_changeHandler(event)"
							  formatString="DD/MM/YYYY"/>
				<mx:Label text="To Date"/>
				<mx:DateField id="Dt_ToDt" formatString="DD/MM/YYYY"/>
				<WrbComp:Button_BB id="Btn_Show" _Label="Show" click="Btn_Show_clickHandler(event)"/>
				<WrbComp:Button_BB id="Btn_ExporttoExcel" width="100" _Label="Export to Excel"
								   click="Btn_ExporttoExcel_clickHandler(event)"/>
				<s:Image buttonMode="true" source="@Embed(source='../Assets/Warning2.png')"
						 toolTip="Recommend to have 30 days search for quicker results"/>
			</s:HGroup>
		</s:BorderContainer>
	</s:VGroup>
</s:Application>
